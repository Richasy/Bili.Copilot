name: "Notify Telegram"
description: "Sends notification to Telegram"
inputs:
  token:
    description: "Telegram Bot Token"
    required: true
  chat-id:
    description: "Telegram Chat ID"
    required: true
  status:
    description: "Job Status"
    required: true
  version:
    description: "App Version"
    required: true
  platform:
    description: "Build Platform"
    required: true
  build-type:
    description: "Build Type (Store/Sideload)"
    required: true
  github-token:
    description: "GitHub Token for fetching artifacts info"
    required: false

runs:
  using: "composite"
  steps:
    - name: Notify Telegram
      if: always()
      shell: pwsh
      env:
        TELEGRAM_TOKEN: ${{ inputs.token }}
        TELEGRAM_CHAT_ID: ${{ inputs.chat-id }}
        JOB_STATUS: ${{ inputs.status }}
        GITHUB_TOKEN: ${{ inputs.github-token }}
      run: |
        $token = $env:TELEGRAM_TOKEN
        $chatId = $env:TELEGRAM_CHAT_ID
        $status = $env:JOB_STATUS
        $ghToken = $env:GITHUB_TOKEN
        $runUrl = "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

        if ([string]::IsNullOrEmpty($token) -or [string]::IsNullOrEmpty($chatId)) {
            Write-Warning "Telegram secrets (TELEGRAM_TOKEN, TELEGRAM_CHAT_ID) not set. Skipping notification."
            exit 0
        }

        if ($status -eq "success") {
            $emoji = "âœ…"
            $title = "å“”å“©åŠ©ç†æ„å»ºæˆåŠŸ"
        } elseif ($status -eq "cancelled") {
            $emoji = "ğŸš«"
            $title = "å“”å“©åŠ©ç†æ„å»ºå–æ¶ˆ"
        } else {
            $emoji = "âŒ"
            $title = "å“”å“©åŠ©ç†æ„å»ºå¤±è´¥"
        }

        $message = "$emoji *$title*`n"
        $message += "ç‰ˆæœ¬: BiliCopilot.UI ${{ inputs.version }} (${{ inputs.platform }})`n"
        $message += "ç±»å‹: ${{ inputs.build-type }}`n"

        if ($status -eq "success") {
            if (-not [string]::IsNullOrEmpty($ghToken)) {
                $message += "`nğŸ“¦ *æ„å»ºäº§ç‰©:*`n"
                try {
                    $apiUrl = "https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts"
                    $headers = @{
                        "Authorization" = "Bearer $ghToken"
                        "Accept"        = "application/vnd.github.v3+json"
                    }
                    $response = Invoke-RestMethod -Uri $apiUrl -Headers $headers -Method Get
                    $artifacts = $response.artifacts
                    
                    if ($artifacts) {
                        foreach ($art in $artifacts) {
                            $sizeMb = [math]::Round($art.size_in_bytes / 1MB, 2)
                            $message += "ğŸ“¦ $($art.name) (${sizeMb} MB)`n"
                        }
                    } else {
                        $message += "æœªæ‰¾åˆ°æ„å»ºäº§ç‰©ã€‚`n"
                    }
                } catch {
                    Write-Warning "Failed to fetch artifacts info: $_"
                    $message += "è·å–æ„å»ºäº§ç‰©ä¿¡æ¯å¤±è´¥ã€‚`n"
                }
            } else {
                $message += "`n(æœªæä¾› GitHub Tokenï¼Œæ— æ³•è·å–äº§ç‰©åˆ—è¡¨)`n"
            }
        } elseif ($status -eq "cancelled") {
            $message += "`nä»»åŠ¡å·²è¢«å–æ¶ˆã€‚`n"
        } else {
            $message += "`nè¯·æŸ¥çœ‹æ—¥å¿—ä»¥è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚`n"
        }

        # Create payload with correct array structure for inline_keyboard
        # Note: The comma before the inner array is crucial to prevent PowerShell from flattening the array
        $payload = @{
            chat_id = $chatId
            text = $message
            parse_mode = "Markdown"
            disable_web_page_preview = $true
            reply_markup = @{
                inline_keyboard = @(
                    , @(
                        @{
                            text = "ğŸ”— æŸ¥çœ‹è¿è¡Œæ—¥å¿—"
                            url = $runUrl
                        }
                    )
                )
            }
        }

        # Convert entire payload to JSON
        $jsonPayload = $payload | ConvertTo-Json -Depth 10 -Compress

        try {
            Invoke-RestMethod -Uri "https://api.telegram.org/bot$token/sendMessage" -Method Post -ContentType "application/json" -Body $jsonPayload
        } catch {
            Write-Warning "Failed to send Telegram notification: $_"
        }
